# TeachHub API

RESTful API для управления курсами, уроками и взаимодействием пользователей на платформе обучения. Написана на C# с использованием ASP.NET 9 с архитектурой Clean Architecture.

## Описание проекта

TeachHub API предоставляет полнофункциональное решение для создания, управления и распространения учебного контента. Система поддерживает иерархическую структуру курсов (курсы → разделы → уроки), реviewm и рейтингование, систему подписок и избранного. Все ID сущностей защищены с помощью HashID шифрования для скрытия структуры базы данных.

## Технологический стек

**Backend:**
- **ASP.NET 9** — фреймворк для разработки API
- **Clean Architecture** — архитектурный паттерн с разделением ответственности
- **Entity Framework Core** — ORM для работы с БД (DB-first подход)
- **Ardalis Specifications** — паттерн для построения типизированных запросов, базовый репозиторий

**База данных:**
- **PostgreSQL** — реляционная база данных
- **Полнотекстовый поиск** — используется TSVECTOR для поиска по курсам
- **Триггеры** — автоматический расчет рейтинга курсов, обновление счетчиков реакций

**Безопасность и шифрование:**
- **JWT (JSON Web Tokens)** — аутентификация и авторизация
- **Argon2** — хеширование паролей с криптографической защитой
- **HashID** — шифрование ID с невозможностью определить последовательность и структуру БД

**Облачное хранилище:**
- **Backblaze B2** — хранилище для иконок курсов и файлов уроков
- **AWS SDK** — интеграция через AWSS3 SDK для работы с объектным хранилищем

**Производительность:**
- **In-Memory Caching** — встроенный ASP.NET кеш для оптимизации часто запрашиваемых данных

## Структура данных

Система организована вокруг следующих основных сущностей:

### Основные таблицы

| Таблица | Назначение |
|---------|-----------|
| `users` | Хранение информации о пользователях (Email, Пароль, Имя) |
| `profiles` | Профили пользователей (Биография, Аватар, Соцсети) |
| `roles` | Роли пользователей (User, Admin) |
| `usersroles` | Связь между пользователями и ролями |
| `courses` | Основная информация о курсах (Название, Описание, Рейтинг) |
| `categories` | Категории курсов с поддержкой иерархии |
| `course_categories` | Связь между курсами и категориями |
| `chapter` | Разделы курсов |
| `lesson` | Уроки внутри разделов |
| `lessonfiles` | Файлы, прикрепленные к урокам |
| `reviews` | Отзывы и рейтинги к курсам |
| `reviewreaction` | Like/Dislike реакции на отзывы |
| `subscription` | Система подписок между пользователями |
| `favorit` | Избранные курсы пользователей |

### Особенности структуры

- **Полнотекстовый поиск**: Поле `searchvector` в таблице courses использует TSVECTOR для быстрого полнотекстового поиска по названиям, описаниям и категориям
- **Каскадное удаление**: При удалении курса автоматически удаляются связанные разделы, уроки, файлы и отзывы
- **Триггеры БД**: Автоматический пересчет рейтинга курса при добавлении/изменении отзывов
- **Счетчики реакций**: Отслеживание количества Like/Dislike на каждый отзыв

## API Эндпоинты

### Аутентификация

- `POST /api/auth/login` — Вход в систему с получением JWT токена
- `POST /api/auth/refrash` — Обновление токена доступа

### Курсы

- `GET /api/courses` — Получить список всех курсов с сортировкой и пагинацией
- `POST /api/courses` — Создать новый курс
- `PATCH /api/courses` — Обновить информацию о курсе
- `GET /api/courses/{courseid}` — Получить информацию о конкретном курсе
- `GET /api/courses/my` — Получить список собственных курсов текущего пользователя
- `DELETE /api/courses/{id}` — Удалить курс
- `PUT /api/courses/icon` — Загрузить или обновить иконку курса

### Категории

- `GET /api/categories` — Получить список категорий с поддержкой поиска и пагинации

### Разделы курсов (Chapters)

- `GET /api/chapters/{courseId}` — Получить все разделы курса
- `POST /api/chapters` — Создать новый раздел в курсе
- `PATCH /api/chapters` — Обновить информацию о разделе
- `DELETE /api/chapters/{chapterid}` — Удалить раздел
- `DELETE /api/chapters/admin/{chapterid}/{userid}` — Удаление раздела администратором

### Уроки

- `GET /api/lessons/{chapterid}` — Получить все уроки в разделе
- `GET /api/lessons/my{chapterid}` — Получить уроки в разделе (режим редактирования для автора)
- `POST /api/lessons` — Создать новый урок
- `PATCH /api/lessons` — Обновить информацию об уроке
- `DELETE /api/lessons/{lessonid}` — Удалить урок
- `PATCH /api/lessons/{lessonid}/visibility` — Изменить видимость урока
- `DELETE /api/lessons/admin/{lessonid}` — Удаление урока администратором

### Файлы уроков

- `GET /api/lessonsfiles/{lessonid}` — Получить файлы урока
- `POST /api/lessonsfiles/files` — Загрузить файл к уроку
- `DELETE /api/lessonsfiles/{fileid}` — Удалить файл

### Отзывы и рейтинги

- `GET /api/reviews` — Получить все отзывы
- `GET /api/reviews/{courseid}` — Получить отзывы о конкретном курсе
- `POST /api/reviews` — Создать новый отзыв на курс
- `PATCH /api/reviews/{reviewid}` — Обновить текст или оценку отзыва
- `DELETE /api/reviews/{reviewid}` — Удалить отзыв

### Реакции на отзывы

- `PUT /api/reviews/reactions` — Добавить или изменить реакцию (Like/Dislike) на отзыв

### Подписки

- `GET /api/user/follows` — Получить список пользователей, на которых подписан текущий пользователь
- `GET /api/user/follows/followers` — Получить список своих подписчиков
- `POST /api/user/follows/{userid}` — Подписаться на пользователя
- `DELETE /api/user/follows/{following}` — Отписаться от пользователя
- `GET /api/user/follows/{userid}` — Получить список пользователей, на которых подписан конкретный пользователь
- `GET /api/user/follows/{userid}/followers` — Получить список подписчиков конкретного пользователя

### Избранное

- `GET /api/favorites` — Получить список избранных курсов текущего пользователя
- `POST /api/favorites/{courseid}` — Добавить курс в избранное
- `DELETE /api/favorites/{courseid}` — Удалить курс из избранного

### Пользователи

- `POST /api/users` — Регистрация нового пользователя
- `GET /api/users/exists` — Проверить наличие пользователя по email
- `DELETE /api/users/remove` — Удалить собственный аккаунт (soft delete)
- `DELETE /api/users/admin/{id}/soft` — Мягко удалить пользователя (администратор)
- `DELETE /api/users/admin/{id}/hard` — Полностью удалить пользователя (администратор)

## Ключевые особенности

### Защита ID в API

Все ID в запросах и ответах используют HashID шифрование. Реальные ID из базы данных остаются скрытыми, что предотвращает определение количества записей и структуры БД. ID автоматически расшифровываются на входе и шифруются на выходе.

Пример:
```
GET /api/courses/jR8vWd  // jR8vWd это HashID, эквивалент ID 1, 2, 3 и т.д.
```

### Полнотекстовый поиск

API поддерживает полнотекстовый поиск по курсам, учитывая названия, описания и категории. Используется встроенная TSVECTOR функциональность PostgreSQL для быстрого поиска.

### Кеширование

ASP.NET In-Memory Cache используется для оптимизации часто запрашиваемых данных таких как:
- Список категорий
- Популярные курсы
- Информация о профилях пользователей

### Облачное хранилище

Все файлы (иконки курсов, материалы уроков) хранятся в Backblaze B2 через AWS SDK, обеспечивая масштабируемость и надежность. Система поддерживает как локальное хранение, так и облачное через флаг `cloudstore`.

### Иерархические данные

Курсы организованы иерархически:
```
Course
  ├── Chapter 1
  │   ├── Lesson 1
  │   │   └── LessonFiles
  │   └── Lesson 2
  └── Chapter 2
      └── Lesson 3
```

Категории также поддерживают иерархию через поле `parentid`.

### Система рейтинга

Рейтинг курса автоматически пересчитывается при каждом изменении отзывов благодаря триггеру БД. Минимальное значение рейтинга — 0, максимальное — 10.

## Безопасность

- **Аутентификация**: JWT токены с проверкой подписи
- **Авторизация**: Ролевая система (User, Admin) с проверкой прав доступа
- **Хеширование паролей**: Argon2 алгоритм с солью
- **Защита ID**: HashID предотвращает угадывание ID и утечку информации о структуре БД
- **Мягкое удаление**: Пользователи и контент помечаются как удаленные вместо полного удаления

## Архитектура

Проект использует Clean Architecture принципы с четким разделением слоев:

- **Domain Layer** — Бизнес-логика и сущности
- **Application Layer** — Use cases и DTOs
- **Infrastructure Layer** — Реализация data access и внешние сервисы (Backblaze, SMTP и т.д.)
- **Presentation Layer** — API контроллеры

Используется паттерн **Specification Pattern** из Ardalis для построения типизированных и переиспользуемых запросов к БД.

## Инструменты разработки

- **Visual Studio 2022** или **Visual Studio Code** — IDE
- **Entity Framework Core** — для миграций и управления БД
- **Swagger/OpenAPI** — автоматическая документация API
- **PostgreSQL Tools** — для администрирования БД

## Примечания

- API использует DB-first подход: структура БД создается отдельно, затем на основе этого генерируются Entity Framework модели
- Все параметры пагинации опциональны, используются значения по умолчанию
- ID в примерах (jR8vWd) — это зашифрованные HashID значения
- Для доступа к защищенным эндпоинтам требуется JWT токен в заголовке Authorization: Bearer {token}